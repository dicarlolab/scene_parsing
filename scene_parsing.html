<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Scene Parsing</title>

<style type="text/css"> 
<!-- 
body  {
	font: 100% 'trebuchet ms', trebuchet, verdana;
	background: #FFFFFF;
	margin: 0; /* it's good practice to zero the margin and padding of the body element to account for differing browser defaults */
	padding: 0;
	text-align: center; /* this centers the container in IE 5* browsers. The text is then set to the left aligned default in the #container selector */
	color: #000000;
}

.thrColElsHdr #container { 
	width: 70em;  /* this width will create a container that will fit in an 800px browser window if text is left at browser default font sizes */
	background: #FFFFFF;
	margin: 10px auto; /* the auto margins (in conjunction with a width) center the page */
	border: 0px solid #000000;
	text-align: left; /* this overrides the text-align: center on the body element. */
} 
.thrColElsHdr #header { 
	background: #DDDDDD; 
	padding: 0px 10px;
	height: 8em;
} 
.thrColElsHdr #header h1 {
	margin: 0; /* zeroing the margin of the last element in the #header div will avoid margin collapse - an unexplainable space between divs. If the div has a border around it, this is not necessary as that also avoids the margin collapse */
	padding: 10px 0; /* using padding instead of margin will allow you to keep the element away from the edges of the div */
}

.thrColElsHdr #sidebar1 {
	float: left; 
	width: 11em; /* since this element is floated, a width must be given */
	height: 40em;
	background: #EBEBEB; /* the background color will be displayed for the length of the content in the column, but no further */
	padding: 15px 0; /* top and bottom padding create visual space within this div */
}
.thrColElsHdr #sidebar2 {
	float: right; 
	width: 20em; /* since this element is floated, a width must be given */
	height: 40em;
	background: #EBEBEB; /* the background color will be displayed for the length of the content in the column, but no further */
	padding: 15px 0; /* top and bottom padding create visual space within this div */
}
.thrColElsHdr #sidebar1 h3, .thrColElsHdr #sidebar1 p, .thrColElsHdr #sidebar2 div, .thrColElsHdr #sidebar2 h3 {
	margin-left: 10px; /* the left and right margin should be given to every element that will be placed in the side columns */
	margin-right: 10px;
}

.thrColElsHdr #mainContent {
 	margin: 0 12em 0 12em; /* the right margin can be given in ems or pixels. It creates the space down the right side of the page. */
 	height:40em
} 
.thrColElsHdr #footer { 
	padding: 0 10px; /* this padding matches the left alignment of the elements in the divs that appear above it. */
	background:#DDDDDD;
} 
.thrColElsHdr #footer p {
	margin: 0; /* zeroing the margins of the first element in the footer will avoid the possibility of margin collapse - a space between divs */
	padding: 10px 0; /* padding on this element will create space, just as the the margin would have, without the margin collapse issue */
}

/* Miscellaneous classes for reuse */
.fltrt { /* this class can be used to float an element right in your page. The floated element must precede the element it should be next to on the page. */
	float: right;
	margin-left: 8px;
}
.fltlft { /* this class can be used to float an element left in your page */
	float: left;
	margin-right: 8px;
}
.clearfloat { /* this class should be placed on a div or break element and should be the final element before the close of a container that should fully contain a float */
	clear:both;
    height:0;
    font-size: 1px;
    line-height: 0px;
}
--> 
</style>

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
<script type="text/javascript" language="JavaScript" src="http://web.mit.edu/esolomon/www/browserdetect.js">
</script>
<script type="text/javascript" src="http://web.mit.edu/esolomon/www/javascripts/jquery.zoom-min.js"></script>
<script type="text/javascript" src="http://web.mit.edu/esolomon/www/zen.js"></script>
<script src="http://web.mit.edu/esolomon/www/javascripts/detect-zoom.js" type="text/javascript"></script>
<script type="text/javascript" src="http://esolomon.scripts.mit.edu/ip.php"></script>

<script type="text/javascript">
		
	function initVars() {
		preproc_init = {"dtype": "uint8",
					 "size": [512, 512, 3],
					 "normalize": false,
					 "mode": "RGB"};
		
		tz = [0];
		obj = ["schnauzer"];
		tx = [0];
		ty = [0];
		rxy = [0];
		s = [1];
		rxz = [0];
		ryz = [0];
		//bgname = "MOUNT_21SN.jpg";		
		bgname = "whitebg.jpg";	
		texture = [null];
		texture_mode = [null];
		internal_canonical = [true];
							 
		spec_init = {"texture_mode": texture_mode,
				"bgpsi": 0.0,
				"texture": texture,
				"tz": tz,
				"obj": obj,
				"tx": tx,
				"ty": ty,
				"bgscale": 1.0,
				"rxy": rxy,
				"s": s,
				"rxz": rxz,
				"ryz": ryz,
				"bgname": bgname,
				"bgphi": 33,
				"internal_canonical":internal_canonical};	
				
		obj_choices = ['schnauzer', '001M', '04_piano', 'maple02', 'MB28089',
						'Professor_pose10', 'Tea_Kettle', 'yacht'];
		init_pos = [[275], [275]];
		currIndex = 0;
	
	}
	
	function addNewObject(newObjName) {
		tz.push(0);
		obj.push(newObjName);
		tx.push(0);
		ty.push(0);
		rxy.push(0);
		s.push(1);
		rxz.push(0);
		ryz.push(0);
		texture.push(null);
		texture_mode.push(null);
		internal_canonical.push(true);
		
		currIndex = jQuery.inArray(newObjName, obj);
		$('#activeobjects').append('<p id="'+obj[currIndex]+'">'+obj[currIndex]+' | <font size="1">Delete this object</font></p>');
		
		createSpec();
		getImg(dispImg);
	
	}
	
	function createSpec() {
	
		spec_init = {"texture_mode": texture_mode,
				"bgpsi": 0.0,
				"texture": texture,
				"tz": tz,
				"obj": obj,
				"tx": tx,
				"ty": ty,
				"bgscale": 1.0,
				"rxy": rxy,
				"s": s,
				"rxz": rxz,
				"ryz": ryz,
				"bgname": bgname,
				"bgphi": 33,
				"internal_canonical":internal_canonical};	
	}
	
	
	function getImg(callback) {
		imgObj = {preproc:JSON.stringify(preproc_init), spec:JSON.stringify(spec_init)};							  
		//imgObj = JSON.stringify(imgObj);
		
		$.get( 'http://50.19.109.25:27719/renderimage', imgObj,
				 success=callback,
				 dataType='jsonp',
				 traditional=true );
	
	}
		
		
	function dispImg(data) {	
		$('#canvas').attr('src', data.url);
	}
	
	function enterData() {
		console.log('enterData');											
		rxy[currIndex] = parseInt(this.rotX.value);										
		ryz[currIndex] = parseInt(this.rotY.value);
		rxz[currIndex] = parseInt(this.rotZ.value);
		obj[currIndex] = this.objname_.value;
		s[currIndex] = parseFloat(this.scale.value);
		ty[currIndex] = parseFloat(this.position_x.value);
		tz[currIndex] = parseFloat(this.position_y.value);
		
		createSpec();
		getImg(dispImg);
	
	}
	
	function generateObjStrip() {
	obj_choices_copy = obj_choices.slice(0);
		//for (i=0; i < obj_choices.length; i++) {
		//	obj[0] = obj_choices[i];
		//	createSpec();
		//	getImg(displayStrip);
		//}
		for (i=0; i < obj_choices.length; i++) {
			$('#stripContainer').append('<div class="stripImg" style="float:left; margin:3px;" id="'+obj_choices[i]+'"><img width=75 height=75 src="" /></div>');
		}
		
		stripURLs = [];
		$('#stripContainer').children().each(function() {
											obj[0] = this.id;
											createSpec();
											getImg(displayStrip);
											});	
	}
	
	function displayStrip(data) {
		stripURLs.push(data.url)		
				
	}
	
	function clickToMove() {
	//There are 0.0055 steps per pixel moved.
		$('#canvas').click(function(e) {
			var offset = $(this).offset();
			var pos_x = e.pageX - offset.left;
			var pos_y = e.pageY - offset.top;
			init_pos[0].push(pos_x);
			init_pos[1].push(pos_y);
			
			pix_change_x = pos_x - init_pos[0][init_pos[0].length-2];
			pix_change_y = pos_y - init_pos[1][init_pos[1].length-2];
			console.log(pix_change_x);
			console.log(pix_change_y);
			
			step_change_x = pix_change_x*0.005505;
			step_change_y = pix_change_y*0.005505;
			
			ty[currIndex] = ty[currIndex]+step_change_x;
			tz[currIndex] = tz[currIndex]-step_change_y;
			
			$('#position_x').attr('value',''+ty[0]);
			$('#position_y').attr('value',''+tz[0]);
			
			createSpec();
			getImg(dispImg);
		});
		
		
	
	
	}
	
	function setFocusOut() {
		$('.control').focusout(function() {											
									if (this.id == "rotX") {																		
										rxy[currIndex] = parseInt(this.value);
									}
									else if (this.id == "rotY") {												
										ryz[currIndex] = parseInt(this.value);
									}
									else if (this.id == "rotZ") {
										rxz[currIndex] = parseInt(this.value)
									}
									else if(this.id == "objname_") {
										obj[currIndex] = this.value
									}
									else if(this.id == "scale") {
										s[currIndex] = parseFloat(this.value);
									}
									else if(this.id == "position_x") {
										ty[currIndex] = parseFloat(this.value);
									}
									else if(this.id == "position_y") {
										tz[currIndex] = parseFloat(this.value);
									}
									createSpec();
									getImg(dispImg);
									});
	
	}
	
	$(document).ready( function() {
		//$('#depthSlider').slider({orientation: 'vertical',
		//						  min: 0,
		//						  max: 100,
		//						  step: 1});
		
		

		
											
		initVars();
		getImg(dispImg);
		//generateObjStrip(); 
		clickToMove();
		
		$('form').submit(function() {enterData()
									return false; }); 
		$('activeobjects').append('<p id="'+obj[currIndex]+'">'+obj[currIndex]+'</p>');
		
		
	});
	
	
</script>
</head>

<body class="thrColElsHdr">

<div id="container">
  <div id="header" style="display:table; width:100%;">
  	<div id="stripContainer" style="vertical-align:middle; display:table-cell;">
  	</div>
  <!-- end #header --></div>
  
  <div id="sidebar1">
    <p align="center">background strip goes here.
  <!-- end #sidebar1 --></div>
  
  <div id="sidebar2">
    <h3>Controls Object Pose</h3>
    
    <div style="float:left;" id="depthSlider"></div>
    <form name="controlForm">
    <div id="rotations">
    	
    	X Rotation Input:
    	<input class="control" type="text" value="0" id="rotX" name="rotX" size=3 />
    	</br>
    	Y Rotation Input:
    	<input class="control" type="text" value="0" id="rotY" name="rotY" size=3 />
    	</br>
    	Z Rotation Input:
    	<input class="control" type="text" value="0" id="rotZ" name="rotZ" size=3 />
    	
    	
	</div>
	
	<h3>Object Identity</h3>
	<div id="objname">
		Input object name:
		<input class="control" id="objname_" size=15 type="text" name="objname_" value="schnauzer" />
	</div>
		
	<h3>Scale</h3>
	<div id="scale_">
		Input object scale:
		<input class="control" id="scale" size=4 type="text" name="scale" value="1.0" />
	</div>
	
	<h3>Position</h3>
		<div id="position_container">
			Input X (horizontal) position:
			<input class="control" id="position_x" size=5 type="text" name="position_x" value="0.0" />
			Input Y (vertical) position:
			<input class="control" id="position_y" size=5 type="text" name="position_y" value="0.0" />
		</div>
		
	<h3>Active Objects</h3>
		<div id="activeobjects">
		</div>
			
	<input type="submit" style="visibility:hidden"/>
	</form>
	
	
  <!-- end #sidebar2 --></div>
  <div id="mainContent">
    <h2> Main Canvas</h2>
    Click on the canvas to position the object.
    <div id="canvas_container" >
    	<img src="" id="canvas" border=1 style="max-height:85%;"/>
    </div>
	<!-- This clearing element should immediately follow the #mainContent div in order to force the #container div to contain all child floats --><br class="clearfloat" />
<!-- end #container --></div>
</body>
</html>